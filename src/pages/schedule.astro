---
import Layout from '~/layouts/Layout.astro';
import { fetchScheduleData } from '~/utils/api.js';

const currentDay = Astro.url.searchParams.get('day') || 'senin';
const currentPage = Number(Astro.url.searchParams.get('page')) || 1;

const daysMap = [
  { id: 'senin', label: 'Senin' },
  { id: 'selasa', label: 'Selasa' },
  { id: 'rabu', label: 'Rabu' },
  { id: 'kamis', label: 'Kamis' },
  { id: 'jumat', label: 'Jumat' },
  { id: 'sabtu', label: 'Sabtu' },
  { id: 'minggu', label: 'Minggu' },
  { id: 'random', label: 'Random' },
  { id: 'all', label: 'Semua' },
];

let animeList = [];
let pagination = {};
let errorMsg = null;

try {
  const res = await fetchScheduleData(currentDay, currentPage);
  animeList = res?.results || [];
  pagination = res?.pagination || {};
} catch (error) {
  console.error("Gagal mengambil data:", error);
  errorMsg = "Gagal memuat jadwal. Silakan coba lagi.";
}

function getPageLink(page) {
  return `?day=${currentDay}&page=${page}`;
}
---

<Layout title="Jadwal Anime" description="Jadwal rilis anime terbaru">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 text-center">Jadwal Anime</h1>

    <div class="flex flex-wrap justify-center gap-2 mb-8">
      {daysMap.map((day) => (
        <a
          href={`?day=${day.id}&page=1`}
          class={`btn btn-sm ${currentDay === day.id ? 'btn-primary' : 'btn-outline border-base-content/20 text-base-content hover:bg-base-content hover:text-base-100'}`}
        >
          {day.label}
        </a>
      ))}
    </div>

    {errorMsg && (
      <div class="alert alert-error shadow-lg mb-8">
        <span>{errorMsg}</span>
      </div>
    )}

    {animeList.length > 0 ? (
      <>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 sm:gap-6 mb-8">
          {animeList.map((anime) => (
            <div class="card bg-base-200 shadow-lg hover:shadow-xl transition-shadow duration-300 group overflow-hidden relative rounded-lg">
              <figure class="relative w-full pb-[140%] overflow-hidden">
                <img
                  src={anime.poster || anime.image || 'https://via.placeholder.com/250x350?text=No+Image'}
                  alt={anime.title}
                  class="absolute inset-0 w-full h-full object-cover transform transition-transform duration-500 group-hover:scale-110"
                  loading="lazy"
                />
                
                {anime.schedule?.time && (
                  <div class="absolute top-2 left-2 bg-black/70 backdrop-blur-sm text-white text-xs font-bold px-2 py-1 rounded shadow-sm border border-white/10">
                    {anime.schedule.time}
                  </div>
                )}

                {anime.quality && (
                   <div class="absolute top-2 right-2 bg-primary/80 backdrop-blur-sm text-primary-content text-[10px] font-bold px-1.5 py-0.5 rounded">
                    {anime.quality}
                  </div>
                )}
              </figure>

              <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/50 to-transparent flex flex-col justify-end p-3 text-white">
                <h3 class="font-bold text-sm sm:text-base leading-snug mb-1 line-clamp-2 group-hover:text-primary transition-colors">
                  {anime.title}
                </h3>

                <div class="text-xs text-gray-300 mb-3 line-clamp-1 opacity-90">
                  {anime.score || 'Belum ada info'}
                </div>

                <div class="card-actions mt-auto">
                  {anime.id && anime.slug ? (
                      <a 
                        href={`/watch/${anime.id}/${anime.slug}`} 
                        class="btn btn-primary btn-xs w-full border-none bg-primary/90 hover:bg-primary shadow-md"
                      >
                        Lihat Detail
                      </a>
                  ) : (
                      <button class="btn btn-disabled btn-xs w-full">Info Tidak Ada</button>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>

        {(pagination.hasNext || pagination.hasPrev) && (
            <div class="flex justify-center items-center gap-4 mt-10">
            <a 
                href={pagination.hasPrev ? getPageLink(currentPage - 1) : '#'} 
                class={`btn btn-sm ${!pagination.hasPrev ? 'btn-disabled opacity-50' : 'btn-outline'}`}
            >
                « Prev
            </a>
            
            <span class="font-bold text-base-content">
                Halaman {currentPage}
            </span>
            
            <a 
                href={pagination.hasNext ? getPageLink(currentPage + 1) : '#'} 
                class={`btn btn-sm ${!pagination.hasNext ? 'btn-disabled opacity-50' : 'btn-outline'}`}
            >
                Next »
            </a>
            </div>
        )}
      </>
    ) : (
      <div class="flex flex-col items-center justify-center min-h-[40vh] opacity-70 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-lg font-semibold">Tidak ada jadwal anime ditemukan untuk hari ini.</p>
        <p class="text-sm mt-2">Coba pilih hari lain atau cek koneksi.</p>
      </div>
    )}
  </div>
</Layout>
